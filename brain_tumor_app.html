<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brain Tumor AI Analysis</title>
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #18181b; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }
        
        /* Loading spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: #6d28d9;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-zinc-900 text-zinc-200 font-sans antialiased">

    <!-- Header -->
    <header class="bg-zinc-800 shadow-lg">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-white">Brain Tumor Classification AI</h1>
            <span class="text-sm text-green-400 font-medium">‚óè Server Connected</span>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container mx-auto p-6 lg:p-12">
        <div class="bg-zinc-800 rounded-lg shadow-2xl overflow-hidden">
            
            <!-- Tab Navigation -->
            <div class="bg-zinc-900 flex border-b border-zinc-700">
                <button id="tab-2d" class="tab-btn active px-6 py-4 font-semibold text-white border-b-2 border-violet-500">
                    2D Slice Analysis (Active)
                </button>
                <button id="tab-3d" class="tab-btn inactive px-6 py-4 font-semibold text-zinc-400 hover:bg-zinc-700">
                    3D Volume Analysis
                </button>
            </div>

            <!-- 2D Analysis Content -->
            <div id="content-2d" class="p-6 md:p-10">
                <p class="text-zinc-300 mb-6">
                    Upload a 2D MRI slice (JPG, PNG) to classify the tumor type and generate a Grad-CAM heatmap, which shows the areas the AI focused on for its decision.
                </p>

                <!-- 2. File Upload Area -->
                <div id="upload-box-2d" class="border-2 border-dashed border-zinc-600 rounded-lg p-10 text-center cursor-pointer hover:border-violet-500 hover:bg-zinc-700 transition-all">
                    <input type="file" id="file-input-2d" class="hidden" accept="image/png, image/jpeg">
                    <svg class="mx-auto h-12 w-12 text-zinc-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3-3 3m0 0l-3 3m3-3v12" />
                    </svg>
                    <p class="mt-2 text-lg font-semibold" id="upload-text-2d">Click or drag file to upload</p>
                    <p class="text-sm text-zinc-400">Supported: JPG, PNG</p>
                </div>

                <!-- 3. Analyze Button -->
                <button id="analyze-btn-2d" class="w-full bg-violet-600 text-white font-bold py-3 px-6 rounded-lg mt-6 hover:bg-violet-700 transition-all opacity-50" disabled>
                    Analyze Scan
                </button>

                <!-- 4. Results Section -->
                <div id="results-2d" class="mt-10 hidden">
                    <h2 class="text-2xl font-bold mb-6 text-white">Analysis Results</h2>
                    
                    <!-- Loading Spinner -->
                    <div id="loading-spinner" class="flex flex-col items-center justify-center p-10 hidden">
                        <div class="spinner"></div>
                        <p class="mt-4 text-lg text-zinc-300">AI is analyzing the scan...</p>
                        <p class="text-sm text-zinc-400">This may take a moment.</p>
                    </div>

                    <!-- Error Message -->
                    <div id="error-message-2d" class="bg-red-900 border border-red-700 text-red-200 px-4 py-3 rounded-lg hidden" role="alert">
                        <strong class="font-bold">Analysis Failed:</strong>
                        <span class="block sm:inline" id="error-text-2d"></span>
                    </div>

                    <!-- Result Cards -->
                    <div id="result-content" class="grid grid-cols-1 md:grid-cols-2 gap-6 hidden">
                        
                        <!-- Prediction Card -->
                        <div class="bg-zinc-700 p-6 rounded-lg shadow-lg">
                            <h3 class="text-lg font-semibold text-zinc-200 mb-4">Prediction</h3>
                            <p class="text-5xl font-bold text-violet-400" id="prediction-label">Meningioma</p>
                            <p class="text-xl text-zinc-300 mt-2" id="confidence-score">98.21% Confidence</p>
                        </div>
                        
                        <!-- 3D Model Card (Placeholder) -->
                        <div class="bg-zinc-700 p-6 rounded-lg shadow-lg">
                            <h3 class="text-lg font-semibold text-zinc-200 mb-4">3D Volume (Placeholder)</h3>
                            <div class="h-32 bg-zinc-800 rounded flex items-center justify-center">
                                <p class="text-zinc-400 text-sm">3D model would render here</p>
                            </div>
                        </div>

                        <!-- Original Image Card -->
                        <div class="bg-zinc-700 p-6 rounded-lg shadow-lg">
                            <h3 class="text-lg font-semibold text-zinc-200 mb-4">Original Scan</h3>
                            <img id="original-image" src="" alt="Original MRI Scan" class="rounded-lg w-full object-contain">
                        </div>

                        <!-- Heatmap Card -->
                        <div class="bg-zinc-700 p-6 rounded-lg shadow-lg">
                            <h3 class="text-lg font-semibold text-zinc-200 mb-4">AI Focus (Grad-CAM Heatmap)</h3>
                            <div id="heatmap-container" class="relative w-full">
                                <!-- The server will send a base64 image which is an overlay of both -->
                                <img id="heatmap-image" src="" alt="AI Heatmap" class="rounded-lg w-full object-contain">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3D Analysis Content -->
            <div id="content-3d" class="p-6 md:p-10 hidden">
                <p class="text-zinc-300 mb-6">
                    This section is for uploading 3D volumetric MRI data (e.g., NIfTI `.nii` or `.nii.gz` files). This feature will use a full 3D CNN model (like from MONAI) to get a more accurate, holistic analysis.
                </p>

                <!-- 3D Upload Box -->
                <div id="upload-box-3d" class="border-2 border-dashed border-zinc-600 rounded-lg p-10 text-center cursor-pointer hover:border-violet-500 hover:bg-zinc-700 transition-all">
                    <input type="file" id="file-input-3d" class="hidden" accept=".nii,.nii.gz">
                    <svg class="mx-auto h-12 w-12 text-zinc-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7m0 10c0 2.21-3.582 4-8 4s-8-1.79-8-4" />
                    </svg>
                    <p class="mt-2 text-lg font-semibold" id="upload-text-3d">Click or drag 3D Volume to upload</p>
                    <p class="text-sm text-zinc-400">Supported: .nii, .nii.gz</p>
                </div>

                <!-- 3D Analyze Button -->
                <button id="analyze-btn-3d" class="w-full bg-violet-600 text-white font-bold py-3 px-6 rounded-lg mt-6 hover:bg-violet-700 transition-all opacity-50" disabled>
                    Analyze 3D Volume
                </button>

                <!-- 3D Results -->
                <div id="results-3d" class="mt-10 hidden">
                    <div id="error-message-3d" class="bg-blue-900 border border-blue-700 text-blue-200 px-4 py-3 rounded-lg" role="alert">
                        <strong class="font-bold">Feature Not Implemented:</strong>
                        <span class="block sm:inline" id="error-text-3d"></span>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- 5. JavaScript Logic ---
        
        // --- API Server URL ---
        const API_URL_2D = 'http://127.0.0.1:5000/analyze_2d';
        const API_URL_3D = 'http://127.0.0.1:5000/analyze_3d';

        // --- Tab Elements ---
        const tab2d = document.getElementById('tab-2d');
        const tab3d = document.getElementById('tab-3d');
        const content2d = document.getElementById('content-2d');
        const content3d = document.getElementById('content-3d');

        // --- 2D Elements ---
        const uploadBox2d = document.getElementById('upload-box-2d');
        const fileInput2d = document.getElementById('file-input-2d');
        const uploadText2d = document.getElementById('upload-text-2d');
        const analyzeBtn2d = document.getElementById('analyze-btn-2d');
        const results2d = document.getElementById('results-2d');
        const loadingSpinner = document.getElementById('loading-spinner');
        const resultError2d = document.getElementById('error-message-2d');
        const errorText2d = document.getElementById('error-text-2d');
        const resultContent = document.getElementById('result-content');
        const predictionLabel = document.getElementById('prediction-label');
        const confidenceScore = document.getElementById('confidence-score');
        const originalImage = document.getElementById('original-image');
        const heatmapImage = document.getElementById('heatmap-image');
        
        // --- 3D Elements ---
        const uploadBox3d = document.getElementById('upload-box-3d');
        const fileInput3d = document.getElementById('file-input-3d');
        const uploadText3d = document.getElementById('upload-text-3d');
        const analyzeBtn3d = document.getElementById('analyze-btn-3d');
        const results3d = document.getElementById('results-3d');
        const resultError3d = document.getElementById('error-message-3d');
        const errorText3d = document.getElementById('error-text-3d');

        let selectedFile2d = null;
        let selectedFile3d = null;

        // --- Tab Switching Logic ---
        tab2d.addEventListener('click', () => {
            tab2d.classList.add('active', 'text-white', 'border-violet-500');
            tab2d.classList.remove('inactive', 'text-zinc-400');
            content2d.classList.remove('hidden');

            tab3d.classList.add('inactive', 'text-zinc-400');
            tab3d.classList.remove('active', 'text-white', 'border-violet-500');
            content3d.classList.add('hidden');
        });

        tab3d.addEventListener('click', () => {
            tab3d.classList.add('active', 'text-white', 'border-violet-500');
            tab3d.classList.remove('inactive', 'text-zinc-400');
            content3d.classList.remove('hidden');

            tab2d.classList.add('inactive', 'text-zinc-400');
            tab2d.classList.remove('active', 'text-white', 'border-violet-500');
            content2d.classList.add('hidden');
        });

        // --- 2D Upload Logic ---
        uploadBox2d.addEventListener('click', () => fileInput2d.click());
        uploadBox2d.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadBox2d.classList.add('border-violet-500', 'bg-zinc-700');
        });
        uploadBox2d.addEventListener('dragleave', () => {
            uploadBox2d.classList.remove('border-violet-500', 'bg-zinc-700');
        });
        uploadBox2d.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadBox2d.classList.remove('border-violet-500', 'bg-zinc-700');
            const file = e.dataTransfer.files[0];
            if (file) handleFile2d(file);
        });
        fileInput2d.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile2d(file);
        });

        function handleFile2d(file) {
            selectedFile2d = file;
            uploadText2d.textContent = file.name;
            analyzeBtn2d.disabled = false;
            analyzeBtn2d.classList.remove('opacity-50');
            
            // Show preview on original image
            const reader = new FileReader();
            reader.onload = (e) => {
                originalImage.src = e.target.result;
            };
            reader.readAsDataURL(file);
            
            // Reset results
            results2d.classList.add('hidden');
            resultContent.classList.add('hidden');
            resultError2d.classList.add('hidden');
        }

        // --- 2D Analyze Button Click ---
        analyzeBtn2d.addEventListener('click', async () => {
            if (!selectedFile2d) return;

            // 1. Show loading state
            results2d.classList.remove('hidden');
            loadingSpinner.classList.remove('hidden');
            resultContent.classList.add('hidden');
            resultError2d.classList.add('hidden');
            analyzeBtn2d.disabled = true;
            analyzeBtn2d.classList.add('opacity-50');
            analyzeBtn2d.textContent = 'Analyzing...';

            // 2. Prepare data for API
            const formData = new FormData();
            formData.append('file', selectedFile2d);

            try {
                // 3. Send to server
                const response = await fetch(API_URL_2D, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || `Server responded with ${response.status}`);
                }

                // 4. Get results
                const data = await response.json();

                // 5. Populate results
                predictionLabel.textContent = data.prediction;
                confidenceScore.textContent = data.confidence;
                
                if (data.heatmapBase64) {
                    heatmapImage.src = 'data:image/jpeg;base64,' + data.heatmapBase64;
                    heatmapImage.classList.remove('hidden');
                } else {
                    heatmapImage.classList.add('hidden');
                }

                // 6. Show results
                loadingSpinner.classList.add('hidden');
                resultContent.classList.remove('hidden');

            } catch (error) {
                // 7. Show error
                console.error('Analysis failed:', error);
                errorText2d.textContent = error.message;
                loadingSpinner.classList.add('hidden');
                resultError2d.classList.remove('hidden');
            } finally {
                // 8. Reset button
                analyzeBtn2d.disabled = false;
                analyzeBtn2d.classList.remove('opacity-50');
                analyzeBtn2d.textContent = 'Analyze Scan';
            }
        });

        // --- 3D Upload Logic ---
        uploadBox3d.addEventListener('click', () => fileInput3d.click());
        uploadBox3d.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadBox3d.classList.add('border-violet-500', 'bg-zinc-700');
        });
        uploadBox3d.addEventListener('dragleave', () => {
            uploadBox3d.classList.remove('border-violet-500', 'bg-zinc-700');
        });
        uploadBox3d.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadBox3d.classList.remove('border-violet-500', 'bg-zinc-700');
            const file = e.dataTransfer.files[0];
            if (file) handleFile3d(file);
        });
        fileInput2d.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile3d(file);
        });

        function handleFile3d(file) {
            selectedFile3d = file;
            uploadText3d.textContent = file.name;
            analyzeBtn3d.disabled = false;
            analyzeBtn3d.classList.remove('opacity-50');
            results3d.classList.add('hidden');
        }

        // --- 3D Analyze Button Click ---
        analyzeBtn3d.addEventListener('click', async () => {
            if (!selectedFile3d) return;

            results3d.classList.remove('hidden');
            analyzeBtn3d.disabled = true;
            analyzeBtn3d.classList.add('opacity-50');
            analyzeBtn3d.textContent = 'Analyzing...';
            
            const formData = new FormData();
            formData.append('file', selectedFile3d);
            
            try {
                const response = await fetch(API_URL_3D, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                // This endpoint is expected to return an error (501)
                if(data.error) {
                    errorText3d.textContent = data.error;
                } else {
                    // Handle a successful 3D analysis one day
                    errorText3d.textContent = "Analysis complete (placeholder).";
                }

            } catch (error) {
                 errorText3d.textContent = error.message;
            } finally {
                analyzeBtn3d.disabled = false;
                analyzeBtn3d.classList.remove('opacity-50');
                analyzeBtn3d.textContent = 'Analyze 3D Volume';
            }
        });
        
    </script>
</body>
</html>

